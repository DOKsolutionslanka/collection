<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Archiving Collection Report - Monthly Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

:root {
--primary-color: #667eea;
--secondary-color: #764ba2;
--success-color: #28a745;
--danger-color: #dc3545;
--warning-color: #ffc107;
--info-color: #17a2b8;
--light-color: #f8f9fa;
--dark-color: #343a40;
--white: #ffffff;
}

body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
min-height: 100vh;
padding: 15px;
transition: background 0.3s ease;
}

body.dark-mode {
background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
}

.container {
background: var(--white);
border-radius: 15px;
box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
max-width: 900px;
width: 100%;
padding: 25px;
margin: 0 auto 20px;
transition: background 0.3s ease, color 0.3s ease;
}

body.dark-mode .container {
background: #2a2a3e;
color: #e0e0e0;
}

header {
text-align: center;
margin-bottom: 25px;
border-bottom: 2px solid var(--primary-color);
padding-bottom: 15px;
position: relative;
}

h1 {
color: #333;
font-size: 1.8em;
margin-bottom: 8px;
transition: color 0.3s ease;
}

body.dark-mode h1 {
color: #e0e0e0;
}

.subtitle {
color: #666;
font-size: 0.95em;
transition: color 0.3s ease;
}

body.dark-mode .subtitle {
color: #b0b0b0;
}

/* Theme Toggle */
.theme-toggle {
position: absolute;
top: 0;
right: 0;
background: none;
border: none;
font-size: 1.2em;
cursor: pointer;
color: #666;
transition: color 0.3s ease;
}

body.dark-mode .theme-toggle {
color: #e0e0e0;
}

/* Month Selector */
.month-selector-container {
display: flex;
justify-content: center;
align-items: center;
gap: 15px;
margin: 20px 0;
padding: 15px;
background: var(--light-color);
border-radius: 10px;
transition: background 0.3s ease;
}

body.dark-mode .month-selector-container {
background: #1a1a2e;
}

.month-selector-container label {
font-weight: 600;
color: #333;
transition: color 0.3s ease;
}

body.dark-mode .month-selector-container label {
color: #e0e0e0;
}

.month-selector {
padding: 10px 15px;
border: 2px solid var(--primary-color);
border-radius: 8px;
background: var(--white);
font-size: 1em;
cursor: pointer;
transition: all 0.3s;
min-width: 180px;
}

body.dark-mode .month-selector {
background: #2a2a3e;
color: #e0e0e0;
}

.month-selector:hover {
border-color: var(--secondary-color);
box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
}

.load-month-btn {
padding: 10px 20px;
background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
color: var(--white);
border: none;
border-radius: 8px;
cursor: pointer;
font-weight: 600;
transition: all 0.3s;
}

.load-month-btn:hover {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.load-month-btn:disabled {
opacity: 0.6;
cursor: not-allowed;
transform: none;
}

/* Action Buttons */
.action-buttons {
display: flex;
justify-content: center;
gap: 10px;
margin: 15px 0;
flex-wrap: wrap;
}

.action-btn {
padding: 8px 15px;
background: var(--light-color);
border: none;
border-radius: 20px;
cursor: pointer;
font-size: 0.9em;
font-weight: 600;
transition: all 0.3s;
}

body.dark-mode .action-btn {
background: #1a1a2e;
color: #e0e0e0;
}

.action-btn:hover {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.action-btn.comparison {
background: linear-gradient(135deg, var(--info-color) 0%, #138496 100%);
color: var(--white);
}

.action-btn.year-summary {
background: linear-gradient(135deg, var(--success-color) 0%, #20c997 100%);
color: var(--white);
}

.action-btn.analysis {
background: linear-gradient(135deg, var(--warning-color) 0%, #e0a800 100%);
color: var(--white);
}

.loading-main {
text-align: center;
padding: 40px 15px;
color: var(--primary-color);
font-size: 1.1em;
}

.spinner {
border: 3px solid #f3f3f3;
border-top: 3px solid var(--primary-color);
border-radius: 50%;
width: 40px;
height: 40px;
animation: spin 1s linear infinite;
margin: 15px auto;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

.main-content {
display: none;
}

.main-content.visible {
display: block;
}

.chart-container {
position: relative;
height: 320px;
margin: 20px auto;
}

/* Net Sales Box - Made Smaller */
.net-sales-highlight {
background: linear-gradient(135deg, #FF9A56 0%, #FF6B6B 100%);
color: var(--white);
padding: 18px;
border-radius: 12px;
text-align: center;
margin: 18px 0;
box-shadow: 0 6px 15px rgba(255, 107, 107, 0.2);
position: relative;
overflow: hidden;
max-width: 70%;
margin-left: auto;
margin-right: auto;
}

.net-sales-highlight::before {
content: '';
position: absolute;
top: -50%;
right: -50%;
width: 200%;
height: 200%;
background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
animation: pulse 3s ease-in-out infinite;
}

@keyframes pulse {
0%, 100% { transform: scale(1); opacity: 0.5; }
50% { transform: scale(1.1); opacity: 0.3; }
}

.net-sales-label {
font-size: 0.9em;
opacity: 0.95;
margin-bottom: 6px;
font-weight: 500;
position: relative;
z-index: 1;
}

.net-sales-value {
font-size: 1.7em;
font-weight: bold;
margin-bottom: 5px;
position: relative;
z-index: 1;
text-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.net-sales-month {
font-size: 0.8em;
opacity: 0.9;
position: relative;
z-index: 1;
}

/* Compact Metrics Row - Now with 4 boxes */
.metrics-row {
display: flex;
justify-content: space-between;
gap: 12px;
margin: 20px 0;
flex-wrap: wrap;
}

.metric-box {
flex: 1;
min-width: 150px;
color: var(--white);
padding: 15px;
border-radius: 12px;
text-align: center;
box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
transition: transform 0.3s ease, box-shadow 0.3s ease;
position: relative;
overflow: hidden;
}

/* Physical Archiving - Purple Gradient */
.metric-box.physical {
background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
}

/* Digital Archiving - Blue Gradient */
.metric-box.digital {
background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

/* Total Collection - Orange/Pink Gradient */
.metric-box.total {
background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.metric-box::before {
content: '';
position: absolute;
top: -50%;
left: -50%;
width: 200%;
height: 200%;
background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
animation: pulse 4s ease-in-out infinite;
}

.metric-box:hover {
transform: translateY(-3px);
box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
}

.metric-box.collection-rate {
background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
}

.metric-label {
font-size: 0.75em;
opacity: 0.95;
margin-bottom: 6px;
font-weight: 500;
position: relative;
z-index: 1;
}

.metric-value {
font-size: 1.4em;
font-weight: bold;
position: relative;
z-index: 1;
text-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.metric-icon {
font-size: 1.2em;
margin-bottom: 6px;
opacity: 0.9;
position: relative;
z-index: 1;
}

/* Download Section */
.download-section {
display: flex;
gap: 10px;
margin: 20px 0;
justify-content: center;
flex-wrap: wrap;
}

.download-btn {
padding: 10px 20px;
border: none;
border-radius: 8px;
font-weight: 600;
cursor: pointer;
transition: all 0.3s ease;
font-size: 0.9em;
display: flex;
align-items: center;
gap: 8px;
box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.download-btn:hover {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.download-btn.pdf {
background: linear-gradient(135deg, var(--danger-color) 0%, #c0392b 100%);
color: var(--white);
}

.download-btn.excel {
background: linear-gradient(135deg, var(--success-color) 0%, #229954 100%);
color: var(--white);
}

.download-btn.csv {
background: linear-gradient(135deg, var(--info-color) 0%, #0d6efd 100%);
color: var(--white);
}

.download-btn:disabled {
opacity: 0.6;
cursor: not-allowed;
transform: none;
}

.breakdown-btn {
width: 100%;
padding: 12px;
background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
color: var(--white);
border: none;
border-radius: 8px;
font-size: 1em;
font-weight: 600;
cursor: pointer;
margin-top: 20px;
transition: transform 0.2s;
}

.breakdown-btn:hover {
transform: translateY(-2px);
}

.breakdown-btn:disabled {
opacity: 0.6;
cursor: not-allowed;
}

.breakdown-section {
display: none;
margin-top: 20px;
}

.breakdown-section.visible {
display: block;
}

/* Search Box */
.search-box {
width: 100%;
padding: 10px 15px;
border: 2px solid var(--primary-color);
border-radius: 8px;
background: var(--white);
font-size: 1em;
margin-bottom: 15px;
}

body.dark-mode .search-box {
background: #2a2a3e;
color: #e0e0e0;
}

/* Filter Options */
.filter-options {
display: flex;
gap: 10px;
margin-bottom: 15px;
flex-wrap: wrap;
}

.filter-btn {
padding: 6px 12px;
background: var(--light-color);
border: 1px solid #ddd;
border-radius: 20px;
cursor: pointer;
font-size: 0.85em;
transition: all 0.3s;
}

body.dark-mode .filter-btn {
background: #1a1a2e;
color: #e0e0e0;
border-color: #444;
}

.filter-btn.active {
background: var(--primary-color);
color: var(--white);
border-color: var(--primary-color);
}

.breakdown-tabs {
display: flex;
gap: 8px;
margin-bottom: 15px;
}

.tab-btn {
flex: 1;
padding: 10px;
border: none;
background: var(--light-color);
cursor: pointer;
border-radius: 6px;
font-weight: 600;
transition: all 0.3s;
font-size: 0.9em;
}

body.dark-mode .tab-btn {
background: #1a1a2e;
color: #e0e0e0;
}

.tab-btn.active {
background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
color: var(--white);
}

.breakdown-content {
display: none;
background: var(--light-color);
border-radius: 8px;
padding: 15px;
max-height: 400px;
overflow-y: auto;
}

body.dark-mode .breakdown-content {
background: #1a1a2e;
}

.breakdown-content.active {
display: block;
}

.breakdown-item {
background: var(--white);
padding: 12px;
margin-bottom: 8px;
border-radius: 6px;
display: flex;
justify-content: space-between;
align-items: center;
box-shadow: 0 2px 4px rgba(0,0,0,0.05);
transition: transform 0.2s;
}

body.dark-mode .breakdown-item {
background: #2a2a3e;
}

.breakdown-item:hover {
transform: translateY(-2px);
}

.customer-name {
font-weight: 600;
color: #333;
flex: 1;
font-size: 0.9em;
}

body.dark-mode .customer-name {
color: #e0e0e0;
}

.amount {
font-weight: bold;
color: var(--primary-color);
font-size: 1em;
}

.loading-spinner {
text-align: center;
padding: 15px;
color: var(--primary-color);
font-size: 0.9em;
}

.summary-header {
background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
color: var(--white);
padding: 12px;
border-radius: 6px;
margin-bottom: 12px;
text-align: center;
font-weight: 600;
font-size: 0.9em;
}

.error-message {
background-color: #ffebee;
color: var(--danger-color);
padding: 12px;
border-radius: 6px;
margin: 15px 0;
text-align: center;
font-size: 0.9em;
}

body.dark-mode .error-message {
background-color: rgba(220, 53, 69, 0.2);
}

.no-data-message {
background-color: #e3f2fd;
color: #1565c0;
padding: 12px;
border-radius: 6px;
margin: 15px 0;
text-align: center;
font-size: 0.9em;
}

body.dark-mode .no-data-message {
background-color: rgba(21, 101, 192, 0.2);
color: #64b5f6;
}

.date-info {
text-align: center;
color: #666;
margin-top: 20px;
font-size: 0.85em;
}

body.dark-mode .date-info {
color: #b0b0b0;
}

.data-source {
text-align: center;
color: #999;
margin-top: 10px;
font-size: 0.8em;
}

body.dark-mode .data-source {
color: #888;
}

/* Toast Notification */
.toast {
position: fixed;
bottom: 20px;
right: 20px;
background: var(--dark-color);
color: var(--white);
padding: 12px 20px;
border-radius: 8px;
box-shadow: 0 4px 12px rgba(0,0,0,0.15);
display: flex;
align-items: center;
gap: 10px;
transform: translateX(120%);
transition: transform 0.3s ease;
z-index: 1000;
}

.toast.show {
transform: translateX(0);
}

.toast.success {
background: var(--success-color);
}

.toast.error {
background: var(--danger-color);
}

.toast.info {
background: var(--info-color);
}

/* Modal Styles */
.modal {
display: none;
position: fixed;
z-index: 1000;
left: 0;
top: 0;
width: 100%;
height: 100%;
background-color: rgba(0,0,0,0.5);
}

.modal-content {
background-color: var(--white);
margin: 3% auto;
padding: 20px;
border-radius: 15px;
width: 95%;
max-width: 1200px;
max-height: 90vh;
overflow-y: auto;
box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
transition: background 0.3s ease;
}

body.dark-mode .modal-content {
background: #2a2a3e;
color: #e0e0e0;
}

.close {
color: #aaa;
float: right;
font-size: 28px;
font-weight: bold;
cursor: pointer;
transition: color 0.3s ease;
}

.close:hover {
color: #000;
}

body.dark-mode .close {
color: #e0e0e0;
}

body.dark-mode .close:hover {
color: #fff;
}

.modal-header {
text-align: center;
margin-bottom: 20px;
border-bottom: 2px solid var(--primary-color);
padding-bottom: 15px;
}

.modal-title {
color: #333;
font-size: 1.5em;
margin-bottom: 8px;
transition: color 0.3s ease;
}

body.dark-mode .modal-title {
color: #e0e0e0;
}

.modal-subtitle {
color: #666;
font-size: 0.95em;
transition: color 0.3s ease;
}

body.dark-mode .modal-subtitle {
color: #b0b0b0;
}

/* Comparison Modal Styles */
.comparison-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
gap: 20px;
margin-bottom: 30px;
}

.comparison-card {
background: linear-gradient(135deg, var(--light-color) 0%, #e9ecef 100%);
border-radius: 12px;
padding: 20px;
text-align: center;
box-shadow: 0 4px 12px rgba(0,0,0,0.1);
transition: transform 0.3s ease;
}

body.dark-mode .comparison-card {
background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
}

.comparison-card:hover {
transform: translateY(-5px);
}

.comparison-value {
font-size: 1.8em;
font-weight: bold;
color: var(--primary-color);
margin-bottom: 8px;
}

.comparison-label {
font-size: 0.9em;
color: #666;
margin-bottom: 5px;
}

body.dark-mode .comparison-label {
color: #b0b0b0;
}

.comparison-change {
font-size: 0.85em;
font-weight: 600;
padding: 4px 8px;
border-radius: 15px;
display: inline-block;
}

.change-positive {
background: #d4edda;
color: #155724;
}

body.dark-mode .change-positive {
background: rgba(40, 167, 69, 0.2);
color: #75c77e;
}

.change-negative {
background: #f8d7da;
color: #721c24;
}

body.dark-mode .change-negative {
background: rgba(220, 53, 69, 0.2);
color: #f1979d;
}

.comparison-chart-container {
position: relative;
height: 400px;
margin: 20px 0;
}

.comparison-table-container {
background: var(--white);
border-radius: 12px;
padding: 20px;
box-shadow: 0 4px 12px rgba(0,0,0,0.1);
margin: 20px 0;
transition: background 0.3s ease;
}

body.dark-mode .comparison-table-container {
background: #2a2a3e;
}

.comparison-table {
width: 100%;
border-collapse: collapse;
}

.comparison-table th {
background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
color: var(--white);
padding: 12px;
text-align: left;
font-weight: 600;
}

.comparison-table td {
padding: 12px;
border-bottom: 1px solid #dee2e6;
}

body.dark-mode .comparison-table td {
border-bottom-color: #444;
}

.comparison-table tr:hover {
background: var(--light-color);
}

body.dark-mode .comparison-table tr:hover {
background: #1a1a2e;
}

.percentage-bar {
background: #e9ecef;
border-radius: 10px;
height: 8px;
overflow: hidden;
margin-top: 5px;
}

body.dark-mode .percentage-bar {
background: #444;
}

.percentage-fill {
height: 100%;
background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
transition: width 0.5s ease;
}

/* Year Summary Modal */
.year-summary-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
gap: 15px;
margin-bottom: 20px;
}

.year-summary-card {
background: linear-gradient(135deg, var(--light-color) 0%, #e9ecef 100%);
border-radius: 10px;
padding: 15px;
text-align: center;
transition: transform 0.3s ease;
}

body.dark-mode .year-summary-card {
background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
}

.year-summary-card:hover {
transform: translateY(-5px);
}

.year-summary-value {
font-size: 1.5em;
font-weight: bold;
color: var(--primary-color);
margin-bottom: 5px;
}

.year-summary-label {
font-size: 0.9em;
color: #666;
}

body.dark-mode .year-summary-label {
color: #b0b0b0;
}

/* Analysis Report Styles */
.analysis-report {
background: var(--white);
border-radius: 12px;
padding: 20px;
margin: 20px 0;
transition: background 0.3s ease;
}

body.dark-mode .analysis-report {
background: #2a2a3e;
}

.analysis-section {
margin-bottom: 30px;
}

.analysis-title {
font-size: 1.2em;
font-weight: bold;
color: #333;
margin-bottom: 15px;
padding-bottom: 8px;
border-bottom: 2px solid var(--primary-color);
transition: color 0.3s ease;
}

body.dark-mode .analysis-title {
color: #e0e0e0;
}

.analysis-table {
width: 100%;
border-collapse: collapse;
margin-top: 15px;
}

.analysis-table th {
background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
color: var(--white);
padding: 12px;
text-align: left;
font-weight: 600;
}

.analysis-table td {
padding: 12px;
border-bottom: 1px solid #dee2e6;
}

body.dark-mode .analysis-table td {
border-bottom-color: #444;
}

.analysis-table tr:hover {
background: var(--light-color);
}

body.dark-mode .analysis-table tr:hover {
background: #1a1a2e;
}

.surplus {
color: var(--success-color);
font-weight: bold;
}

.deficit {
color: var(--danger-color);
font-weight: bold;
}

.neutral {
color: #6c757d;
font-weight: bold;
}

/* Responsive adjustments */
@media (max-width: 768px) {
.metrics-row {
flex-direction: column;
}

.metric-box {
min-width: 100%;
}

.container {
padding: 20px;
}

h1 {
font-size: 1.6em;
}

.chart-container {
height: 280px;
}

.download-section {
flex-direction: column;
align-items: center;
}

.download-btn {
width: 200px;
justify-content: center;
}

.month-selector-container {
flex-direction: column;
gap: 10px;
}

.action-buttons {
flex-direction: column;
gap: 10px;
}

.modal-content {
width: 98%;
margin: 5% auto;
padding: 15px;
}

.comparison-grid {
grid-template-columns: 1fr;
}
}

/* For smaller laptops */
@media (max-width: 1024px) {
.container {
max-width: 95%;
}

.metrics-row {
gap: 8px;
}

.metric-box {
min-width: 140px;
padding: 12px;
}

.metric-value {
font-size: 1.2em;
}

.metric-label {
font-size: 0.7em;
}
}

/* For very small screens */
@media (max-width: 480px) {
.metrics-row {
gap: 10px;
}

.metric-box {
min-width: 120px;
padding: 10px;
}

.metric-value {
font-size: 1.1em;
}

.metric-label {
font-size: 0.65em;
}
}
</style>
</head>
<body>
<div class="container">
<header>
<button class="theme-toggle" onclick="toggleTheme()">🌙</button>
<h1>📊 Archiving Collection Report</h1>
<p class="subtitle" id="subtitle">Monthly Collection Summary - Select Month to Begin</p>
</header>

<!-- Month Selector -->
<div class="month-selector-container">
<label for="monthSelector">Select Month:</label>
<select id="monthSelector" class="month-selector">
<option value="">-- Select Month --</option>
</select>
<button id="loadMonthBtn" class="load-month-btn" onclick="loadSelectedMonth()" disabled>
Load Data
</button>
</div>

<!-- Action Buttons -->
<div class="action-buttons">
<button class="action-btn comparison" onclick="openComparisonModal()">
📊 Month Comparison
</button>
<button class="action-btn year-summary" onclick="showYearSummary()">
📅 Year Summary
</button>
<button class="action-btn analysis" onclick="showAnalysisReport()">
📈 Analysis Report
</button>
</div>

<div class="loading-main" id="loadingMain">
<div class="spinner"></div>
<div id="loadingText">Please select a month to load data</div>
</div>

<div class="main-content" id="mainContent">
<div id="errorMessage" class="error-message" style="display: none;"></div>

<!-- Net Sales Box - Made Smaller -->
<div class="net-sales-highlight">
<div class="net-sales-label">Previous Month Net Sales</div>
<div class="net-sales-value" id="netSaleValue">Rs. 0</div>
<div class="net-sales-month" id="netSaleMonth">Loading...</div>
</div>

<div class="chart-container">
<canvas id="pieChart"></canvas>
</div>

<!-- Compact Metrics Row - Now with 4 boxes including Total -->
<div class="metrics-row">
<div class="metric-box physical">
<div class="metric-icon">📁</div>
<div class="metric-label">Physical Archiving (PA)</div>
<div class="metric-value" id="paValue">Rs. 0</div>
</div>

<div class="metric-box digital">
<div class="metric-icon">💻</div>
<div class="metric-label">Digital Archiving (DA)</div>
<div class="metric-value" id="daValue">Rs. 0</div>
</div>

<div class="metric-box total">
<div class="metric-icon">💰</div>
<div class="metric-label">Total Collection</div>
<div class="metric-value" id="totalValue">Rs. 0</div>
</div>

<div class="metric-box collection-rate">
<div class="metric-icon">🎯</div>
<div class="metric-label">Collection Rate</div>
<div class="metric-value" id="collectionRateValue">0%</div>
</div>
</div>

<!-- Download Section -->
<div class="download-section">
<button class="download-btn pdf" onclick="downloadPDF()" id="pdfBtn">
📄 Download PDF
</button>
<button class="download-btn excel" onclick="downloadExcel()" id="excelBtn">
📊 Download Excel
</button>
<button class="download-btn csv" onclick="downloadCSV()" id="csvBtn">
📋 Download CSV
</button>
</div>

<button class="breakdown-btn" id="breakdownBtn" onclick="toggleBreakdown()">
📋 View Detailed Breakdown by Customer
</button>

<div class="breakdown-section" id="breakdownSection">
<div class="breakdown-tabs">
<button class="tab-btn active" onclick="showTab('physical')">Physical Archiving</button>
<button class="tab-btn" onclick="showTab('digital')">Digital Archiving</button>
</div>

<div class="breakdown-content active" id="physicalContent">
<input type="text" class="search-box" id="physicalSearch" placeholder="Search customers..." onkeyup="filterCustomers('physical')">
<div class="filter-options">
<button class="filter-btn active" onclick="setFilter('physical', 'all', this)">All</button>
<button class="filter-btn" onclick="setFilter('physical', 'high', this)">High Value</button>
<button class="filter-btn" onclick="setFilter('physical', 'medium', this)">Medium Value</button>
<button class="filter-btn" onclick="setFilter('physical', 'low', this)">Low Value</button>
</div>
<div class="loading-spinner">Loading data...</div>
</div>

<div class="breakdown-content" id="digitalContent">
<input type="text" class="search-box" id="digitalSearch" placeholder="Search customers..." onkeyup="filterCustomers('digital')">
<div class="filter-options">
<button class="filter-btn active" onclick="setFilter('digital', 'all', this)">All</button>
<button class="filter-btn" onclick="setFilter('digital', 'high', this)">High Value</button>
<button class="filter-btn" onclick="setFilter('digital', 'medium', this)">Medium Value</button>
<button class="filter-btn" onclick="setFilter('digital', 'low', this)">Low Value</button>
</div>
<div class="loading-spinner">Loading data...</div>
</div>
</div>

<div class="date-info">
Report generated as of <span id="currentDate">October 21, 2025</span>
</div>
<div class="data-source">
Data Source: Collection Report - DOK
</div>
</div>
</div>

<!-- Comparison Modal -->
<div id="comparisonModal" class="modal">
<div class="modal-content">
<span class="close" onclick="closeComparisonModal()">&times;</span>
<div class="modal-header">
<h2 class="modal-title">📊 Month Comparison Analysis</h2>
<p class="modal-subtitle" id="comparisonSubtitle">Compare collection performance between months</p>
</div>

<div class="comparison-grid" id="comparisonGrid">
<!-- Comparison cards will be populated here -->
</div>

<div class="comparison-chart-container">
<canvas id="comparisonChart"></canvas>
</div>

<div class="comparison-table-container">
<h3 style="margin-bottom: 15px; color: #333;">Detailed Comparison Table</h3>
<table class="comparison-table" id="comparisonTable">
<thead>
<tr>
<th>Metric</th>
<th id="currentMonthHeader">Current Month</th>
<th id="previousMonthHeader">Previous Month</th>
<th>Change</th>
<th>Change %</th>
</tr>
</thead>
<tbody id="comparisonTableBody">
<!-- Table data will be populated here -->
</tbody>
</table>
</div>

<div class="download-section">
<button class="download-btn pdf" onclick="downloadComparisonPDF()">
📄 Download Comparison PDF
</button>
<button class="download-btn excel" onclick="downloadComparisonExcel()">
📊 Download Comparison Excel
</button>
</div>
</div>
</div>

<!-- Year Summary Modal -->
<div id="yearSummaryModal" class="modal">
<div class="modal-content">
<span class="close" onclick="closeYearSummary()">&times;</span>
<div class="modal-header">
<h2 class="modal-title">📅 Year Summary Report</h2>
<p class="modal-subtitle" id="yearSummarySubtitle">April 2025 - March 2026</p>
</div>
<div class="year-summary-grid" id="yearSummaryGrid">
<!-- Year summary cards will be populated here -->
</div>
<div class="chart-container">
<canvas id="yearSummaryChart"></canvas>
</div>
<div class="download-section">
<button class="download-btn pdf" onclick="downloadYearSummaryPDF()">
📄 Download Year Summary PDF
</button>
<button class="download-btn excel" onclick="downloadYearSummaryExcel()">
📊 Download Year Summary Excel
</button>
</div>
</div>
</div>

<!-- Analysis Report Modal -->
<div id="analysisModal" class="modal">
<div class="modal-content">
<span class="close" onclick="closeAnalysisModal()">&times;</span>
<div class="modal-header">
<h2 class="modal-title">📈 Monthly Collection Analysis Report</h2>
<p class="modal-subtitle">Collection percentages and surplus/deficit analysis</p>
</div>

<div class="analysis-report">
<div class="analysis-section">
<h3 class="analysis-title">Monthly Collection Performance</h3>
<table class="analysis-table" id="analysisTable">
<thead>
<tr>
<th>Month</th>
<th>Physical Archiving</th>
<th>Digital Archiving</th>
<th>Total Collection</th>
<th>Collection %</th>
<th>Related Sales</th>
<th>Surplus/(Deficit)</th>
</tr>
</thead>
<tbody id="analysisTableBody">
<!-- Analysis data will be populated here -->
</tbody>
</table>
</div>

<div class="chart-container">
<canvas id="analysisChart"></canvas>
</div>

<div class="download-section">
<button class="download-btn pdf" onclick="downloadAnalysisPDF()">
📄 Download Analysis PDF
</button>
<button class="download-btn excel" onclick="downloadAnalysisExcel()">
📊 Download Analysis Excel
</button>
</div>
</div>
</div>
</div>

<!-- Toast Notification -->
<div id="toast" class="toast">
<span id="toastMessage"></span>
</div>

<script>
// Monthly URLs Configuration with all provided GIDs
const MONTHLY_URLS = {
    'April 2025': 'https://docs.google.com/spreadsheets/d/1ke3ape3CKmGwxJwHOvZGKizdOON7OryBawSE6lY-u5o/export?format=csv&gid=350434986',
    'May 2025': 'https://docs.google.com/spreadsheets/d/1ke3ape3CKmGwxJwHOvZGKizdOON7OryBawSE6lY-u5o/export?format=csv&gid=47387108',
    'June 2025': 'https://docs.google.com/spreadsheets/d/1ke3ape3CKmGwxJwHOvZGKizdOON7OryBawSE6lY-u5o/export?format=csv&gid=224812122',
    'July 2025': 'https://docs.google.com/spreadsheets/d/1ke3ape3CKmGwxJwHOvZGKizdOON7OryBawSE6lY-u5o/export?format=csv&gid=1843469422',
    'August 2025': 'https://docs.google.com/spreadsheets/d/1ke3ape3CKmGwxJwHOvZGKizdOON7OryBawSE6lY-u5o/export?format=csv&gid=413949890',
    'September 2025': 'https://docs.google.com/spreadsheets/d/1ke3ape3CKmGwxJwHOvZGKizdOON7OryBawSE6lY-u5o/export?format=csv&gid=92473044',
    'October 2025': 'https://docs.google.com/spreadsheets/d/1ke3ape3CKmGwxJwHOvZGKizdOON7OryBawSE6lY-u5o/export?format=csv&gid=0',
    'November 2025': 'https://docs.google.com/spreadsheets/d/1ke3ape3CKmGwxJwHOvZGKizdOON7OryBawSE6lY-u5o/export?format=csv&gid=807760582',
    'December 2025': 'https://docs.google.com/spreadsheets/d/1ke3ape3CKmGwxJwHOvZGKizdOON7OryBawSE6lY-u5o/export?format=csv&gid=1186146528',
    'January 2026': 'https://docs.google.com/spreadsheets/d/1ke3ape3CKmGwxJwHOvZGKizdOON7OryBawSE6lY-u5o/export?format=csv&gid=1531365897',
    'February 2026': 'https://docs.google.com/spreadsheets/d/1ke3ape3CKmGwxJwHOvZGKizdOON7OryBawSE6lY-u5o/export?format=csv&gid=858571237',
    'March 2026': 'https://docs.google.com/spreadsheets/d/1ke3ape3CKmGwxJwHOvZGKizdOON7OryBawSE6lY-u5o/export?format=csv&gid=1206756823'
};

// Global variables
let physicalArchiving = 0;
let digitalArchiving = 0;
let total = 0;
let breakdownData = null;
let chartInstance = null;
let comparisonChartInstance = null;
let yearSummaryChartInstance = null;
let analysisChartInstance = null;
let isBreakdownVisible = false;
let reportMonth = '';
let previousMonthNetSales = 0;
let previousMonthName = '';
let breakdownProcessed = false;
let physicalMap = {};
let digitalMap = {};
let currentMonth = '';
let previousMonthData = null;
let yearSummaryData = {};
let allMonthsData = {};
let dataCache = {}; // Cache for loaded data
let currentFilter = {
    physical: 'all',
    digital: 'all'
};
let isDarkMode = false;

// Initialize month selector
function initializeMonthSelector() {
    const monthSelector = document.getElementById('monthSelector');
    
    // Clear existing options
    monthSelector.innerHTML = '<option value="">-- Select Month --</option>';
    
    // Add months from configuration
    Object.keys(MONTHLY_URLS).forEach(month => {
        const option = document.createElement('option');
        option.value = month;
        option.textContent = month;
        monthSelector.appendChild(option);
    });
    
    // Add change event listener
    monthSelector.addEventListener('change', function() {
        const loadBtn = document.getElementById('loadMonthBtn');
        loadBtn.disabled = !this.value;
    });
}

// Load selected month data
function loadSelectedMonth() {
    const monthSelector = document.getElementById('monthSelector');
    currentMonth = monthSelector.value;
    
    if (!currentMonth) {
        showError('Please select a month');
        return;
    }
    
    // Check if data is already cached
    if (dataCache[currentMonth]) {
        console.log('Loading data from cache for', currentMonth);
        useCachedData(currentMonth);
        return;
    }
    
    const url = MONTHLY_URLS[currentMonth];
    if (!url) {
        showError('URL not found for selected month');
        return;
    }
    
    // Show loading
    document.getElementById('loadingMain').style.display = 'block';
    document.getElementById('loadingText').textContent = `Loading data for ${currentMonth}...`;
    document.getElementById('mainContent').classList.remove('visible');
    
    // Load data
    Papa.parse(url, {
        download: true,
        complete: function(results) {
            try {
                if (!results.data || results.data.length === 0) {
                    throw new Error('No data received from Google Sheets');
                }
                
                const totals = calculateTotals(results.data);
                physicalArchiving = totals.physical;
                digitalArchiving = totals.digital;
                total = physicalArchiving + digitalArchiving;
                
                // Store data for breakdown
                breakdownData = results.data;
                
                // Cache the data
                dataCache[currentMonth] = {
                    physicalArchiving,
                    digitalArchiving,
                    total,
                    breakdownData,
                    reportMonth,
                    previousMonthNetSales,
                    previousMonthName
                };
                
                // Process breakdown data
                processBreakdownData();
                
                // Update UI
                updateUI();
                createChart();
                
                // Hide loading, show content
                document.getElementById('loadingMain').style.display = 'none';
                document.getElementById('mainContent').classList.add('visible');
                
                // Show success toast
                showToast(`Data loaded successfully for ${currentMonth}`, 'success');
                
            } catch (error) {
                console.error('Error processing data:', error);
                showError('Error processing data: ' + error.message);
                showToast('Error processing data', 'error');
            }
        },
        error: function(error) {
            console.error('Error loading data:', error);
            showError('Error loading data. Please ensure the Google Sheet is publicly accessible.');
            showToast('Error loading data', 'error');
        }
    });
}

// Use cached data
function useCachedData(month) {
    const cachedData = dataCache[month];
    
    physicalArchiving = cachedData.physicalArchiving;
    digitalArchiving = cachedData.digitalArchiving;
    total = cachedData.total;
    breakdownData = cachedData.breakdownData;
    reportMonth = cachedData.reportMonth;
    previousMonthNetSales = cachedData.previousMonthNetSales;
    previousMonthName = cachedData.previousMonthName;
    
    // Process breakdown data
    processBreakdownData();
    
    // Update UI
    updateUI();
    createChart();
    
    // Hide loading, show content
    document.getElementById('loadingMain').style.display = 'none';
    document.getElementById('mainContent').classList.add('visible');
    
    // Show success toast
    showToast(`Data loaded from cache for ${month}`, 'info');
}

// Toggle theme
function toggleTheme() {
    isDarkMode = !isDarkMode;
    document.body.classList.toggle('dark-mode');
    
    const themeToggle = document.querySelector('.theme-toggle');
    themeToggle.textContent = isDarkMode ? '☀️' : '🌙';
    
    // Update chart colors if charts exist
    if (chartInstance) {
        updateChartTheme(chartInstance);
    }
    
    if (comparisonChartInstance) {
        updateChartTheme(comparisonChartInstance);
    }
    
    if (yearSummaryChartInstance) {
        updateChartTheme(yearSummaryChartInstance);
    }
    
    if (analysisChartInstance) {
        updateChartTheme(analysisChartInstance);
    }
    
    // Save theme preference
    localStorage.setItem('darkMode', isDarkMode);
}

// Update chart theme
function updateChartTheme(chart) {
    const textColor = isDarkMode ? '#e0e0e0' : '#333';
    const gridColor = isDarkMode ? '#444' : '#ddd';
    
    chart.options.plugins.legend.labels.color = textColor;
    chart.options.plugins.title.color = textColor;
    
    if (chart.options.scales) {
        if (chart.options.scales.x) {
            chart.options.scales.x.ticks.color = textColor;
            chart.options.scales.x.grid.color = gridColor;
            if (chart.options.scales.x.title) {
                chart.options.scales.x.title.color = textColor;
            }
        }
        if (chart.options.scales.y) {
            chart.options.scales.y.ticks.color = textColor;
            chart.options.scales.y.grid.color = gridColor;
            if (chart.options.scales.y.title) {
                chart.options.scales.y.title.color = textColor;
            }
        }
    }
    
    chart.update();
}

// Show toast notification
function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    
    toast.className = 'toast ' + type;
    toastMessage.textContent = message;
    
    toast.classList.add('show');
    
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

// Set filter for breakdown
function setFilter(type, filter, button) {
    currentFilter[type] = filter;
    
    // Update active button
    const container = type === 'physical' ? 
        document.querySelector('#physicalContent .filter-options') : 
        document.querySelector('#digitalContent .filter-options');
    
    container.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    button.classList.add('active');
    
    // Apply filter
    renderCategory(type + 'Content', type === 'physical' ? physicalMap : digitalMap, 
                  type === 'physical' ? 'Physical Archiving' : 'Digital Archiving');
}

// Filter customers based on search input
function filterCustomers(type) {
    const searchInput = document.getElementById(type + 'Search');
    const searchTerm = searchInput.value.toLowerCase();
    
    renderCategory(type + 'Content', type === 'physical' ? physicalMap : digitalMap, 
                  type === 'physical' ? 'Physical Archiving' : 'Digital Archiving', searchTerm);
}

// Open comparison modal
function openComparisonModal() {
    if (!currentMonth) {
        showToast('Please select and load a month first', 'error');
        return;
    }
    
    document.getElementById('comparisonModal').style.display = 'block';
    loadComparisonData();
}

// Close comparison modal
function closeComparisonModal() {
    document.getElementById('comparisonModal').style.display = 'none';
}

// Load comparison data
async function loadComparisonData() {
    const months = Object.keys(MONTHLY_URLS);
    const currentIndex = months.indexOf(currentMonth);
    
    if (currentIndex <= 0) {
        document.getElementById('comparisonGrid').innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #666;">No previous month available for comparison</div>';
        return;
    }
    
    const previousMonth = months[currentIndex - 1];
    
    // Check if previous month data is cached
    if (dataCache[previousMonth]) {
        console.log('Loading comparison data from cache for', previousMonth);
        const cachedData = dataCache[previousMonth];
        previousMonthData = {
            physical: cachedData.physicalArchiving,
            digital: cachedData.digitalArchiving,
            total: cachedData.total,
            month: previousMonth,
            netSales: cachedData.previousMonthNetSales
        };
        
        updateComparisonUI();
        return;
    }
    
    const previousUrl = MONTHLY_URLS[previousMonth];
    
    // Show loading state
    document.getElementById('comparisonGrid').innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px;"><div class="spinner"></div><div>Loading comparison data...</div></div>';
    
    try {
        const response = await fetch(previousUrl);
        const csvText = await response.text();
        const results = Papa.parse(csvText, { header: false });
        
        if (results.data && results.data.length > 0) {
            const totals = calculateTotals(results.data);
            
            // Cache the previous month data
            dataCache[previousMonth] = {
                physicalArchiving: totals.physical,
                digitalArchiving: totals.digital,
                total: totals.physical + totals.digital,
                breakdownData: results.data,
                reportMonth,
                previousMonthNetSales,
                previousMonthName
            };
            
            previousMonthData = {
                physical: totals.physical,
                digital: totals.digital,
                total: totals.physical + totals.digital,
                month: previousMonth,
                netSales: previousMonthNetSales
            };
            
            updateComparisonUI();
        }
    } catch (error) {
        console.error('Error loading comparison data:', error);
        document.getElementById('comparisonGrid').innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #dc3545;">Error loading comparison data</div>';
        showToast('Error loading comparison data', 'error');
    }
}

// Update comparison UI
function updateComparisonUI() {
    if (!previousMonthData) return;
    
    // Update subtitle
    document.getElementById('comparisonSubtitle').textContent = `${currentMonth} vs ${previousMonthData.month}`;
    
    // Calculate changes
    const physicalChange = physicalArchiving - previousMonthData.physical;
    const digitalChange = digitalArchiving - previousMonthData.digital;
    const totalChange = total - previousMonthData.total;
    
    const physicalChangePercent = previousMonthData.physical > 0 ? (physicalChange / previousMonthData.physical * 100) : 0;
    const digitalChangePercent = previousMonthData.digital > 0 ? (digitalChange / previousMonthData.digital * 100) : 0;
    const totalChangePercent = previousMonthData.total > 0 ? (totalChange / previousMonthData.total * 100) : 0;
    
    // Update comparison grid
    document.getElementById('comparisonGrid').innerHTML = `
        <div class="comparison-card">
            <div class="comparison-label">Physical Archiving</div>
            <div class="comparison-value">${formatCurrency(physicalArchiving)}</div>
            <div class="comparison-change ${physicalChange >= 0 ? 'change-positive' : 'change-negative'}">
                ${physicalChange >= 0 ? '↑' : '↓'} ${formatCurrency(Math.abs(physicalChange))}
            </div>
        </div>
        <div class="comparison-card">
            <div class="comparison-label">Digital Archiving</div>
            <div class="comparison-value">${formatCurrency(digitalArchiving)}</div>
            <div class="comparison-change ${digitalChange >= 0 ? 'change-positive' : 'change-negative'}">
                ${digitalChange >= 0 ? '↑' : '↓'} ${formatCurrency(Math.abs(digitalChange))}
            </div>
        </div>
        <div class="comparison-card">
            <div class="comparison-label">Total Collection</div>
            <div class="comparison-value">${formatCurrency(total)}</div>
            <div class="comparison-change ${totalChange >= 0 ? 'change-positive' : 'change-negative'}">
                ${totalChange >= 0 ? '↑' : '↓'} ${formatCurrency(Math.abs(totalChange))}
            </div>
        </div>
        <div class="comparison-card">
            <div class="comparison-label">Collection Rate</div>
            <div class="comparison-value">${totalChangePercent.toFixed(1)}%</div>
            <div class="comparison-change ${totalChangePercent >= 0 ? 'change-positive' : 'change-negative'}">
                ${totalChangePercent >= 0 ? '↑' : '↓'} ${Math.abs(totalChangePercent).toFixed(1)}%
            </div>
        </div>
    `;
    
    // Update table headers
    document.getElementById('currentMonthHeader').textContent = currentMonth;
    document.getElementById('previousMonthHeader').textContent = previousMonthData.month;
    
    // Update table body
    document.getElementById('comparisonTableBody').innerHTML = `
        <tr>
            <td>Physical Archiving</td>
            <td>${formatCurrency(physicalArchiving)}</td>
            <td>${formatCurrency(previousMonthData.physical)}</td>
            <td class="${physicalChange >= 0 ? 'surplus' : 'deficit'}">${formatCurrency(physicalChange)}</td>
            <td class="${physicalChangePercent >= 0 ? 'surplus' : 'deficit'}">${physicalChangePercent.toFixed(1)}%</td>
        </tr>
        <tr>
            <td>Digital Archiving</td>
            <td>${formatCurrency(digitalArchiving)}</td>
            <td>${formatCurrency(previousMonthData.digital)}</td>
            <td class="${digitalChange >= 0 ? 'surplus' : 'deficit'}">${formatCurrency(digitalChange)}</td>
            <td class="${digitalChangePercent >= 0 ? 'surplus' : 'deficit'}">${digitalChangePercent.toFixed(1)}%</td>
        </tr>
        <tr>
            <td><strong>Total Collection</strong></td>
            <td><strong>${formatCurrency(total)}</strong></td>
            <td><strong>${formatCurrency(previousMonthData.total)}</strong></td>
            <td class="${totalChange >= 0 ? 'surplus' : 'deficit'}"><strong>${formatCurrency(totalChange)}</strong></td>
            <td class="${totalChangePercent >= 0 ? 'surplus' : 'deficit'}"><strong>${totalChangePercent.toFixed(1)}%</strong></td>
        </tr>
    `;
    
    // Create comparison chart
    createComparisonChart();
}

// Create comparison chart
function createComparisonChart() {
    const ctx = document.getElementById('comparisonChart').getContext('2d');
    
    if (comparisonChartInstance) {
        comparisonChartInstance.destroy();
    }
    
    comparisonChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Physical Archiving', 'Digital Archiving', 'Total Collection'],
            datasets: [
                {
                    label: currentMonth,
                    data: [physicalArchiving, digitalArchiving, total],
                    backgroundColor: '#667eea',
                    borderColor: '#667eea',
                    borderWidth: 1
                },
                {
                    label: previousMonthData.month,
                    data: [previousMonthData.physical, previousMonthData.digital, previousMonthData.total],
                    backgroundColor: '#36A2EB',
                    borderColor: '#36A2EB',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.dataset.label || '';
                            const value = formatCurrency(context.parsed.y);
                            return `${label}: ${value}`;
                        }
                    }
                },
                title: {
                    display: true,
                    text: `${currentMonth} vs ${previousMonthData.month} Comparison`,
                    font: { size: 16 },
                    padding: { top: 10, bottom: 15 }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return formatCurrency(value);
                        }
                    }
                }
            }
        }
    });
    
    // Apply theme if dark mode is active
    if (isDarkMode) {
        updateChartTheme(comparisonChartInstance);
    }
}

// Show year summary
function showYearSummary() {
    document.getElementById('yearSummaryModal').style.display = 'block';
    loadYearSummaryData();
}

// Close year summary
function closeYearSummary() {
    document.getElementById('yearSummaryModal').style.display = 'none';
}

// Load year summary data
async function loadYearSummaryData() {
    const months = Object.keys(MONTHLY_URLS);
    yearSummaryData = {};
    
    document.getElementById('yearSummaryGrid').innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px;"><div class="spinner"></div><div>Loading year summary...</div></div>';
    
    for (const month of months) {
        // Check if data is already cached
        if (dataCache[month]) {
            console.log('Using cached data for', month);
            const cachedData = dataCache[month];
            yearSummaryData[month] = {
                physical: cachedData.physicalArchiving,
                digital: cachedData.digitalArchiving,
                total: cachedData.total,
                netSales: cachedData.previousMonthNetSales
            };
            continue;
        }
        
        try {
            const response = await fetch(MONTHLY_URLS[month]);
            const csvText = await response.text();
            const results = Papa.parse(csvText, { header: false });
            
            if (results.data && results.data.length > 0) {
                const totals = calculateTotals(results.data);
                
                // Cache the data
                dataCache[month] = {
                    physicalArchiving: totals.physical,
                    digitalArchiving: totals.digital,
                    total: totals.physical + totals.digital,
                    breakdownData: results.data,
                    reportMonth,
                    previousMonthNetSales,
                    previousMonthName
                };
                
                yearSummaryData[month] = {
                    physical: totals.physical,
                    digital: totals.digital,
                    total: totals.physical + totals.digital,
                    netSales: previousMonthNetSales
                };
            }
        } catch (error) {
            console.error(`Error loading ${month}:`, error);
            yearSummaryData[month] = { physical: 0, digital: 0, total: 0, netSales: 0 };
        }
    }
    
    updateYearSummaryUI();
}

// Update year summary UI
function updateYearSummaryUI() {
    const months = Object.keys(yearSummaryData);
    let totalPhysical = 0;
    let totalDigital = 0;
    let grandTotal = 0;
    let bestMonth = '';
    let worstMonth = '';
    let bestTotal = 0;
    let worstTotal = Infinity;
    let totalCollectionPercent = 0;
    let validMonthsCount = 0;
    
    months.forEach(month => {
        const data = yearSummaryData[month];
        totalPhysical += data.physical;
        totalDigital += data.digital;
        grandTotal += data.total;
        
        // Calculate collection percentage for months with valid net sales
        if (data.netSales > 0) {
            // Calculate percentage and add to total
            const monthCollectionPercent = (data.total / data.netSales) * 100;
            totalCollectionPercent += monthCollectionPercent;
            validMonthsCount++;
        }
        
        if (data.total > bestTotal) {
            bestTotal = data.total;
            bestMonth = month;
        }
        
        if (data.total < worstTotal) {
            worstTotal = data.total;
            worstMonth = month;
        }
    });
    
    const averageMonthly = grandTotal / months.length;
    // Calculate average collection percentage as total of all percentages divided by number of months
    const averageCollectionPercent = validMonthsCount > 0 ? (totalCollectionPercent / validMonthsCount) : 0;
    
    // Update summary grid
    document.getElementById('yearSummaryGrid').innerHTML = `
        <div class="year-summary-card">
            <div class="year-summary-value">${formatCurrency(grandTotal)}</div>
            <div class="year-summary-label">Total Collection</div>
        </div>
        <div class="year-summary-card">
            <div class="year-summary-value">${formatCurrency(totalPhysical)}</div>
            <div class="year-summary-label">Physical Archiving</div>
        </div>
        <div class="year-summary-card">
            <div class="year-summary-value">${formatCurrency(totalDigital)}</div>
            <div class="year-summary-label">Digital Archiving</div>
        </div>
        <div class="year-summary-card">
            <div class="year-summary-value">${formatCurrency(averageMonthly)}</div>
            <div class="year-summary-label">Average Monthly</div>
        </div>
        <div class="year-summary-card">
            <div class="year-summary-value">${bestMonth}</div>
            <div class="year-summary-label">Best Month</div>
        </div>
        <div class="year-summary-card">
            <div class="year-summary-value">${worstMonth}</div>
            <div class="year-summary-label">Lowest Month</div>
        </div>
        <div class="year-summary-card">
            <div class="year-summary-value">${averageCollectionPercent.toFixed(1)}%</div>
            <div class="year-summary-label">Average Collection %</div>
        </div>
    `;
    
    // Create year summary chart
    createYearSummaryChart();
}

// Create year summary chart
function createYearSummaryChart() {
    const ctx = document.getElementById('yearSummaryChart').getContext('2d');
    
    if (yearSummaryChartInstance) {
        yearSummaryChartInstance.destroy();
    }
    
    const months = Object.keys(yearSummaryData).sort();
    const physicalData = months.map(month => yearSummaryData[month].physical);
    const digitalData = months.map(month => yearSummaryData[month].digital);
    
    yearSummaryChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: months,
            datasets: [
                {
                    label: 'Physical Archiving',
                    data: physicalData,
                    backgroundColor: '#667eea'
                },
                {
                    label: 'Digital Archiving',
                    data: digitalData,
                    backgroundColor: '#36A2EB'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${formatCurrency(context.parsed.y)}`;
                        }
                    }
                },
                title: {
                    display: true,
                    text: 'Yearly Collection Overview',
                    font: { size: 16 },
                    padding: { top: 10, bottom: 15 }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return formatCurrency(value);
                        }
                    }
                }
            }
        }
    });
    
    // Apply theme if dark mode is active
    if (isDarkMode) {
        updateChartTheme(yearSummaryChartInstance);
    }
}

// Show analysis report
function showAnalysisReport() {
    document.getElementById('analysisModal').style.display = 'block';
    loadAnalysisData();
}

// Close analysis modal
function closeAnalysisModal() {
    document.getElementById('analysisModal').style.display = 'none';
}

// Load analysis data
async function loadAnalysisData() {
    const months = Object.keys(MONTHLY_URLS);
    allMonthsData = {};
    
    // Show loading state
    document.getElementById('analysisTableBody').innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;"><div class="spinner"></div>Loading analysis data...</td></tr>';
    
    for (const month of months) {
        // Check if data is already cached
        if (dataCache[month]) {
            console.log('Using cached data for', month);
            const cachedData = dataCache[month];
            allMonthsData[month] = {
                physical: cachedData.physicalArchiving,
                digital: cachedData.digitalArchiving,
                total: cachedData.total,
                netSales: cachedData.previousMonthNetSales
            };
            continue;
        }
        
        try {
            const response = await fetch(MONTHLY_URLS[month]);
            const csvText = await response.text();
            const results = Papa.parse(csvText, { header: false });
            
            if (results.data && results.data.length > 0) {
                const totals = calculateTotals(results.data);
                
                // Cache the data
                dataCache[month] = {
                    physicalArchiving: totals.physical,
                    digitalArchiving: totals.digital,
                    total: totals.physical + totals.digital,
                    breakdownData: results.data,
                    reportMonth,
                    previousMonthNetSales,
                    previousMonthName
                };
                
                allMonthsData[month] = {
                    physical: totals.physical,
                    digital: totals.digital,
                    total: totals.physical + totals.digital,
                    netSales: previousMonthNetSales
                };
            }
        } catch (error) {
            console.error(`Error loading ${month}:`, error);
            allMonthsData[month] = { physical: 0, digital: 0, total: 0, netSales: 0 };
        }
    }
    
    updateAnalysisUI();
}

// Update analysis UI
function updateAnalysisUI() {
    // Define the correct order of months (fiscal year from April to March)
    const monthOrder = [
        'April 2025', 'May 2025', 'June 2025', 'July 2025', 
        'August 2025', 'September 2025', 'October 2025', 
        'November 2025', 'December 2025', 'January 2026', 
        'February 2026', 'March 2026'
    ];
    
    // Filter to only include months that have data
    const months = monthOrder.filter(month => allMonthsData[month]);
    
    let totalCollection = 0;
    let totalNetSales = 0;
    
    // Calculate totals for percentage calculation
    months.forEach(month => {
        const data = allMonthsData[month];
        totalCollection += data.total;
        totalNetSales += data.netSales;
    });
    
    let tableHTML = '';
    
    months.forEach(month => {
        const data = allMonthsData[month];
        const collectionPercent = data.netSales > 0 ? (data.total / data.netSales * 100) : 0;
        const surplusDeficit = data.total - data.netSales;
        
        tableHTML += `
            <tr>
                <td><strong>${month}</strong></td>
                <td>${formatCurrency(data.physical)}</td>
                <td>${formatCurrency(data.digital)}</td>
                <td><strong>${formatCurrency(data.total)}</strong></td>
                <td>
                    <div>${collectionPercent.toFixed(1)}%</div>
                    <div class="percentage-bar">
                        <div class="percentage-fill" style="width: ${collectionPercent}%"></div>
                    </div>
                </td>
                <td>${formatCurrency(data.netSales)}</td>
                <td class="${surplusDeficit >= 0 ? 'surplus' : 'deficit'}">
                    ${surplusDeficit >= 0 ? '+' : ''}${formatCurrency(surplusDeficit)}
                </td>
            </tr>
        `;
    });
    
    document.getElementById('analysisTableBody').innerHTML = tableHTML;
    
    // Create analysis chart
    createAnalysisChart();
}

// Create analysis chart
function createAnalysisChart() {
    const ctx = document.getElementById('analysisChart').getContext('2d');
    
    if (analysisChartInstance) {
        analysisChartInstance.destroy();
    }
    
    // Define the correct order of months (fiscal year from April to March)
    const monthOrder = [
        'April 2025', 'May 2025', 'June 2025', 'July 2025', 
        'August 2025', 'September 2025', 'October 2025', 
        'November 2025', 'December 2025', 'January 2026', 
        'February 2026', 'March 2026'
    ];
    
    // Filter to only include months that have data
    const months = monthOrder.filter(month => allMonthsData[month]);
    
    // Create data arrays in the correct chronological order
    const collectionData = [];
    const netSalesData = [];
    
    months.forEach(month => {
        if (allMonthsData[month]) {
            collectionData.push(allMonthsData[month].total);
            netSalesData.push(allMonthsData[month].netSales);
        }
    });
    
    analysisChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: months,
            datasets: [
                {
                    label: 'Collection',
                    data: collectionData,
                    borderColor: '#667eea',
                    backgroundColor: '#667eea20',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 5,
                    pointHoverRadius: 7
                },
                {
                    label: 'Related Sales',
                    data: netSalesData,
                    borderColor: '#36A2EB',
                    backgroundColor: '#36A2EB20',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        padding: 15,
                        font: { size: 12 }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${formatCurrency(context.parsed.y)}`;
                        }
                    }
                },
                title: {
                    display: true,
                    text: 'Monthly Collection Performance (April 2025 - March 2026)',
                    font: { size: 16 },
                    padding: { top: 10, bottom: 15 }
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Months',
                        font: { size: 12 }
                    },
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45
                    }
                },
                y: {
                    beginAtZero: true,
                    display: true,
                    title: {
                        display: true,
                        text: 'Amount (Rs.)',
                        font: { size: 12 }
                    },
                    ticks: {
                        callback: function(value) {
                            return formatCurrency(value);
                        }
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
    
    // Apply theme if dark mode is active
    if (isDarkMode) {
        updateChartTheme(analysisChartInstance);
    }
}

// Format currency in thousands
function formatCurrency(value) {
    return 'Rs. ' + Math.round(value).toLocaleString('en-LK', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    });
}

// Calculate totals from sheet data
function calculateTotals(data) {
    let paTotal = 0;
    let daTotal = 0;
    let rowsProcessed = 0;

    // Debug: Log the first few rows to understand the structure
    console.log('First 3 rows of data:', data.slice(0, 3));

    // Try to get month from T1 cell (row 0, column 19)
    if (data[0] && data[0][19]) {
        reportMonth = data[0][19].trim();
        console.log('Found report month in T1:', reportMonth);
    } else {
        // Try alternative positions for month
        if (data[0] && data[0][18]) {
            reportMonth = data[0][18].trim();
            console.log('Found report month in S1:', reportMonth);
        }
    }

    // Try to get previous month name from S2 cell (row 1, column 18)
    if (data[1] && data[1][18]) {
        previousMonthName = data[1][18].trim();
        console.log('Found previous month name in S2:', previousMonthName);
    }

    // Try to get previous month net sales from T2 cell (row 1, column 19)
    if (data[1] && data[1][19]) {
        let netSalesStr = String(data[1][19]).replace(/,/g, '').replace(/\s/g, '').replace('Rs.', '').replace('LKR', '');
        previousMonthNetSales = parseFloat(netSalesStr) || 0;
        console.log('Found previous month net sales in T2:', previousMonthNetSales);
    }

    console.log('Report Month:', reportMonth);
    console.log('Previous Month Name:', previousMonthName);
    console.log('Previous Month Net Sales:', previousMonthNetSales);

    // Process ALL rows dynamically - skip header (row 0) and continue until end
    for (let i = 1; i < data.length; i++) {
        const row = data[i];

        // Skip completely empty rows
        if (!row || row.length === 0) continue;

        // Skip rows without operating unit in column A
        if (!row[0] || row[0].trim() === '') continue;

        const operatingUnit = row[0].trim();

        // Only process Physical Archiving or Digital Archiving rows
        if (operatingUnit !== 'Physical Archiving' && operatingUnit !== 'Digital Archiving') {
            continue;
        }

        // Get amount from column G (index 6), handle comma-separated values
        let amountStr = row[6];
        if (!amountStr || amountStr === '') continue;

        // Remove commas, spaces, and currency symbols if present
        amountStr = String(amountStr).replace(/,/g, '').replace(/\s/g, '').replace('Rs.', '').replace('LKR', '');
        const amount = parseFloat(amountStr);

        if (isNaN(amount) || amount === 0) continue;

        if (operatingUnit === 'Physical Archiving') {
            paTotal += amount;
            rowsProcessed++;
        } else if (operatingUnit === 'Digital Archiving') {
            daTotal += amount;
            rowsProcessed++;
        }
    }

    console.log('Rows Processed:', rowsProcessed);
    console.log('Physical Total:', paTotal);
    console.log('Digital Total:', daTotal);
    console.log('Grand Total:', paTotal + daTotal);

    return { physical: paTotal, digital: daTotal };
}

// Show error message
function showError(message) {
    const errorElement = document.getElementById('errorMessage');
    errorElement.textContent = message;
    errorElement.style.display = 'block';

    document.getElementById('loadingMain').style.display = 'none';
    document.getElementById('mainContent').classList.add('visible');
}

// Update UI with calculated values
function updateUI() {
    // Calculate collection as percentage of previous month net sales
    const collectionPercent = previousMonthNetSales > 0 ? ((total / previousMonthNetSales) * 100).toFixed(1) : 0;

    document.getElementById('paValue').textContent = formatCurrency(physicalArchiving);
    document.getElementById('daValue').textContent = formatCurrency(digitalArchiving);
    document.getElementById('totalValue').textContent = formatCurrency(total);

    // Update net sales box
    document.getElementById('netSaleValue').textContent = formatCurrency(previousMonthNetSales);
    document.getElementById('netSaleMonth').textContent = previousMonthName || 'Previous Month';

    // Update collection rate
    document.getElementById('collectionRateValue').textContent = collectionPercent + '%';

    // Update subtitle with month from T1
    document.getElementById('subtitle').textContent = 'Monthly Collection Summary - ' + (reportMonth || currentMonth);

    // Update current date
    const today = new Date();
    const dateStr = today.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    document.getElementById('currentDate').textContent = dateStr;
}

// Create pie chart
function createChart() {
    const ctx = document.getElementById('pieChart').getContext('2d');

    if (chartInstance) {
        chartInstance.destroy();
    }

    // Original pie chart colors
    const physicalColor = '#FF6384'; // Pink/red color
    const digitalColor = '#36A2EB'; // Blue color

    chartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Physical Archiving (PA)', 'Digital Archiving (DA)'],
            datasets: [{
                data: [physicalArchiving, digitalArchiving],
                backgroundColor: [physicalColor, digitalColor],
                borderColor: ['#fff', '#fff'],
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: { size: 12 }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                            return label + ': ' + formatCurrency(value) + ' (' + percentage + '%)';
                        }
                    }
                },
                title: {
                    display: true,
                    text: (reportMonth || currentMonth) + ' Collection Distribution',
                    font: { size: 14 },
                    padding: { top: 8, bottom: 15 }
                }
            }
        }
    });
    
    // Apply theme if dark mode is active
    if (isDarkMode) {
        updateChartTheme(chartInstance);
    }
}

// Download PDF function
function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Add title
    doc.setFontSize(20);
    doc.text('Archiving Collection Report', 105, 20, { align: 'center' });

    // Add subtitle
    doc.setFontSize(12);
    doc.text(reportMonth || currentMonth, 105, 30, { align: 'center' });

    // Add generation date
    const today = new Date();
    doc.text(`Generated: ${today.toLocaleDateString()}`, 105, 37, { align: 'center' });

    // Add summary section
    doc.setFontSize(14);
    doc.text('Summary', 20, 50);

    // Add metrics
    doc.setFontSize(11);
    const collectionPercent = previousMonthNetSales > 0 ? ((total / previousMonthNetSales) * 100).toFixed(1) : 0;

    const summaryData = [
        ['Metric', 'Amount'],
        ['Previous Month Net Sales', formatCurrency(previousMonthNetSales)],
        ['Physical Archiving (PA)', formatCurrency(physicalArchiving)],
        ['Digital Archiving (DA)', formatCurrency(digitalArchiving)],
        ['Total Collection', formatCurrency(total)],
        ['Collection Rate', collectionPercent + '%']
    ];

    // Add summary table
    doc.autoTable({
        head: [summaryData[0]],
        body: summaryData.slice(1),
        startY: 55,
        theme: 'grid',
        styles: {
            fontSize: 10,
            cellPadding: 3
        },
        headStyles: {
            fillColor: [102, 126, 234],
            textColor: 255
        }
    });

    // Add breakdown sections
    let finalY = doc.lastAutoTable.finalY + 10;

    // Physical Archiving Breakdown
    if (Object.keys(physicalMap).length > 0) {
        doc.setFontSize(14);
        doc.text('Physical Archiving Breakdown', 20, finalY);
        finalY += 7;

        const physicalData = Object.entries(physicalMap)
            .sort((a, b) => b[1] - a[1])
            .map(([customer, amount]) => [customer, formatCurrency(amount)]);

        doc.autoTable({
            head: [['Customer', 'Amount']],
            body: physicalData,
            startY: finalY,
            theme: 'grid',
            styles: {
                fontSize: 9,
                cellPadding: 2
            },
            headStyles: {
                fillColor: [102, 126, 234],
                textColor: 255
            }
        });

        finalY = doc.lastAutoTable.finalY + 10;
    }

    // Digital Archiving Breakdown
    if (Object.keys(digitalMap).length > 0) {
        doc.setFontSize(14);
        doc.text('Digital Archiving Breakdown', 20, finalY);
        finalY += 7;

        const digitalData = Object.entries(digitalMap)
            .sort((a, b) => b[1] - a[1])
            .map(([customer, amount]) => [customer, formatCurrency(amount)]);

        doc.autoTable({
            head: [['Customer', 'Amount']],
            body: digitalData,
            startY: finalY,
            theme: 'grid',
            styles: {
                fontSize: 9,
                cellPadding: 2
            },
            headStyles: {
                fillColor: [79, 172, 254],
                textColor: 255
            }
        });
    }

    // Save the PDF
    doc.save(`Archiving_Collection_Report_${(reportMonth || currentMonth).replace(/\s+/g, '_')}.pdf`);
    
    // Show success toast
    showToast('PDF downloaded successfully', 'success');
}

// Download Excel function
function downloadExcel() {
    // Create workbook
    const wb = XLSX.utils.book_new();

    // Create summary worksheet
    const wsSummaryData = [
        ['Archiving Collection Report'],
        ['Month', reportMonth || currentMonth],
        ['Generated Date', new Date().toLocaleDateString()],
        [''],
        ['Summary'],
        ['Metric', 'Amount'],
        ['Previous Month Net Sales', previousMonthNetSales],
        ['Physical Archiving (PA)', physicalArchiving],
        ['Digital Archiving (DA)', digitalArchiving],
        ['Total Collection', total],
        ['Collection Rate (%)', previousMonthNetSales > 0 ? ((total / previousMonthNetSales) * 100).toFixed(1) : 0]
    ];

    const wsSummary = XLSX.utils.aoa_to_sheet(wsSummaryData);
    XLSX.utils.book_append_sheet(wb, wsSummary, 'Summary');

    // Create Physical Archiving worksheet
    if (Object.keys(physicalMap).length > 0) {
        const physicalData = Object.entries(physicalMap)
            .sort((a, b) => b[1] - a[1])
            .map(([customer, amount], index) => [
                index + 1,
                customer,
                amount
            ]);

        physicalData.unshift(['No', 'Customer', 'Amount']);
        const wsPhysical = XLSX.utils.aoa_to_sheet(physicalData);
        XLSX.utils.book_append_sheet(wb, wsPhysical, 'Physical Archiving');
    }

    // Create Digital Archiving worksheet
    if (Object.keys(digitalMap).length > 0) {
        const digitalData = Object.entries(digitalMap)
            .sort((a, b) => b[1] - a[1])
            .map(([customer, amount], index) => [
                index + 1,
                customer,
                amount
            ]);

        digitalData.unshift(['No', 'Customer', 'Amount']);
        const wsDigital = XLSX.utils.aoa_to_sheet(digitalData);
        XLSX.utils.book_append_sheet(wb, wsDigital, 'Digital Archiving');
    }

    // Save the Excel file
    XLSX.writeFile(wb, `Archiving_Collection_Report_${(reportMonth || currentMonth).replace(/\s+/g, '_')}.xlsx`);
    
    // Show success toast
    showToast('Excel file downloaded successfully', 'success');
}

// Download CSV function
function downloadCSV() {
    // Create CSV content
    let csvContent = "Archiving Collection Report\n";
    csvContent += `Month,${reportMonth || currentMonth}\n`;
    csvContent += `Generated Date,${new Date().toLocaleDateString()}\n\n`;
    
    csvContent += "Summary\n";
    csvContent += "Metric,Amount\n";
    csvContent += `Previous Month Net Sales,${previousMonthNetSales}\n`;
    csvContent += `Physical Archiving (PA),${physicalArchiving}\n`;
    csvContent += `Digital Archiving (DA),${digitalArchiving}\n`;
    csvContent += `Total Collection,${total}\n`;
    csvContent += `Collection Rate (%),${previousMonthNetSales > 0 ? ((total / previousMonthNetSales) * 100).toFixed(1) : 0}\n\n`;
    
    // Physical Archiving Breakdown
    if (Object.keys(physicalMap).length > 0) {
        csvContent += "Physical Archiving Breakdown\n";
        csvContent += "Customer,Amount\n";
        
        const physicalData = Object.entries(physicalMap)
            .sort((a, b) => b[1] - a[1]);
            
        physicalData.forEach(([customer, amount]) => {
            csvContent += `"${customer}",${amount}\n`;
        });
        
        csvContent += "\n";
    }
    
    // Digital Archiving Breakdown
    if (Object.keys(digitalMap).length > 0) {
        csvContent += "Digital Archiving Breakdown\n";
        csvContent += "Customer,Amount\n";
        
        const digitalData = Object.entries(digitalMap)
            .sort((a, b) => b[1] - a[1]);
            
        digitalData.forEach(([customer, amount]) => {
            csvContent += `"${customer}",${amount}\n`;
        });
    }
    
    // Create blob and download
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    link.setAttribute('download', `Archiving_Collection_Report_${(reportMonth || currentMonth).replace(/\s+/g, '_')}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Show success toast
    showToast('CSV file downloaded successfully', 'success');
}

// Download comparison PDF
function downloadComparisonPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Add title
    doc.setFontSize(20);
    doc.text('Month Comparison Report', 105, 20, { align: 'center' });

    // Add subtitle
    doc.setFontSize(12);
    doc.text(`${currentMonth} vs ${previousMonthData.month}`, 105, 30, { align: 'center' });

    // Add generation date
    const today = new Date();
    doc.text(`Generated: ${today.toLocaleDateString()}`, 105, 37, { align: 'center' });

    // Add comparison data
    const physicalChange = physicalArchiving - previousMonthData.physical;
    const digitalChange = digitalArchiving - previousMonthData.digital;
    const totalChange = total - previousMonthData.total;

    const comparisonData = [
        ['Metric', currentMonth, previousMonthData.month, 'Change', 'Change %'],
        ['Physical Archiving', formatCurrency(physicalArchiving), formatCurrency(previousMonthData.physical), 
         formatCurrency(physicalChange), ((physicalChange / previousMonthData.physical) * 100).toFixed(1) + '%'],
        ['Digital Archiving', formatCurrency(digitalArchiving), formatCurrency(previousMonthData.digital), 
         formatCurrency(digitalChange), ((digitalChange / previousMonthData.digital) * 100).toFixed(1) + '%'],
        ['Total Collection', formatCurrency(total), formatCurrency(previousMonthData.total), 
         formatCurrency(totalChange), ((totalChange / previousMonthData.total) * 100).toFixed(1) + '%']
    ];

    doc.autoTable({
        head: [comparisonData[0]],
        body: comparisonData.slice(1),
        startY: 50,
        theme: 'grid',
        styles: {
            fontSize: 10,
            cellPadding: 3
        },
        headStyles: {
            fillColor: [102, 126, 234],
            textColor: 255
        }
    });

    doc.save(`Month_Comparison_${currentMonth}_vs_${previousMonthData.month}.pdf`);
    
    // Show success toast
    showToast('Comparison PDF downloaded successfully', 'success');
}

// Download comparison Excel
function downloadComparisonExcel() {
    const wb = XLSX.utils.book_new();

    const physicalChange = physicalArchiving - previousMonthData.physical;
    const digitalChange = digitalArchiving - previousMonthData.digital;
    const totalChange = total - previousMonthData.total;

    const comparisonData = [
        ['Month Comparison Report'],
        [''],
        ['Period', `${currentMonth} vs ${previousMonthData.month}`],
        ['Generated Date', new Date().toLocaleDateString()],
        [''],
        ['Comparison Analysis'],
        ['Metric', currentMonth, previousMonthData.month, 'Change', 'Change %'],
        ['Physical Archiving', physicalArchiving, previousMonthData.physical, physicalChange, (physicalChange / previousMonthData.physical * 100).toFixed(1) + '%'],
        ['Digital Archiving', digitalArchiving, previousMonthData.digital, digitalChange, (digitalChange / previousMonthData.digital * 100).toFixed(1) + '%'],
        ['Total Collection', total, previousMonthData.total, totalChange, (totalChange / previousMonthData.total * 100).toFixed(1) + '%']
    ];

    const wsComparison = XLSX.utils.aoa_to_sheet(comparisonData);
    XLSX.utils.book_append_sheet(wb, wsComparison, 'Comparison');

    XLSX.writeFile(wb, `Month_Comparison_${currentMonth}_vs_${previousMonthData.month}.xlsx`);
    
    // Show success toast
    showToast('Comparison Excel file downloaded successfully', 'success');
}

// Download year summary PDF
function downloadYearSummaryPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Add title
    doc.setFontSize(20);
    doc.text('Yearly Collection Summary', 105, 20, { align: 'center' });

    // Add subtitle
    doc.setFontSize(12);
    doc.text('April 2025 - March 2026', 105, 30, { align: 'center' });

    // Add generation date
    const today = new Date();
    doc.text(`Generated: ${today.toLocaleDateString()}`, 105, 37, { align: 'center' });

    // Calculate yearly totals
    const months = Object.keys(yearSummaryData);
    let totalPhysical = 0;
    let totalDigital = 0;
    let grandTotal = 0;
    let totalCollectionPercent = 0;
    let validMonthsCount = 0;
    
    months.forEach(month => {
        const data = yearSummaryData[month];
        totalPhysical += data.physical;
        totalDigital += data.digital;
        grandTotal += data.total;
        
        // Calculate collection percentage for months with valid net sales
        if (data.netSales > 0) {
            // Calculate percentage and add to total
            const monthCollectionPercent = (data.total / data.netSales) * 100;
            totalCollectionPercent += monthCollectionPercent;
            validMonthsCount++;
        }
    });
    
    const averageMonthly = grandTotal / months.length;
    // Calculate average collection percentage as total of all percentages divided by number of months
    const averageCollectionPercent = validMonthsCount > 0 ? (totalCollectionPercent / validMonthsCount) : 0;

    // Add summary section
    doc.setFontSize(14);
    doc.text('Yearly Summary', 20, 50);

    const summaryData = [
        ['Metric', 'Amount'],
        ['Total Physical Archiving', formatCurrency(totalPhysical)],
        ['Total Digital Archiving', formatCurrency(totalDigital)],
        ['Grand Total Collection', formatCurrency(grandTotal)],
        ['Average Monthly Collection', formatCurrency(averageMonthly)],
        ['Number of Months', months.length],
        ['Average Collection %', averageCollectionPercent.toFixed(1) + '%']
    ];

    doc.autoTable({
        head: [summaryData[0]],
        body: summaryData.slice(1),
        startY: 55,
        theme: 'grid',
        styles: {
            fontSize: 10,
            cellPadding: 3
        },
        headStyles: {
            fillColor: [102, 126, 234],
            textColor: 255
        }
    });

    // Add monthly breakdown
    let finalY = doc.lastAutoTable.finalY + 10;
    doc.setFontSize(14);
    doc.text('Monthly Breakdown', 20, finalY);
    finalY += 7;

    const monthlyData = [['Month', 'Physical', 'Digital', 'Total', 'Collection %', 'Related Sales', 'Surplus/(Deficit)']];
    months.sort().forEach(month => {
        const data = yearSummaryData[month];
        const collectionPercent = data.netSales > 0 ? (data.total / data.netSales * 100) : 0;
        const surplusDeficit = data.total - data.netSales;
        
        monthlyData.push([
            month,
            formatCurrency(data.physical),
            formatCurrency(data.digital),
            formatCurrency(data.total),
            collectionPercent.toFixed(1) + '%',
            formatCurrency(data.netSales),
            (surplusDeficit >= 0 ? '+' : '') + formatCurrency(surplusDeficit)
        ]);
    });

    doc.autoTable({
        head: [monthlyData[0]],
        body: monthlyData.slice(1),
        startY: finalY,
        theme: 'grid',
        styles: {
            fontSize: 9,
            cellPadding: 2
        },
        headStyles: {
            fillColor: [102, 126, 234],
            textColor: 255
        }
    });

    doc.save('Yearly_Collection_Summary.pdf');
    
    // Show success toast
    showToast('Year Summary PDF downloaded successfully', 'success');
}

// Download year summary Excel
function downloadYearSummaryExcel() {
    const wb = XLSX.utils.book_new();

    const months = Object.keys(yearSummaryData);
    let totalPhysical = 0;
    let totalDigital = 0;
    let grandTotal = 0;
    let totalCollectionPercent = 0;
    let validMonthsCount = 0;
    
    months.forEach(month => {
        const data = yearSummaryData[month];
        totalPhysical += data.physical;
        totalDigital += data.digital;
        grandTotal += data.total;
        
        // Calculate collection percentage for months with valid net sales
        if (data.netSales > 0) {
            // Calculate percentage and add to total
            const monthCollectionPercent = (data.total / data.netSales) * 100;
            totalCollectionPercent += monthCollectionPercent;
            validMonthsCount++;
        }
    });

    const averageMonthly = grandTotal / months.length;
    // Calculate average collection percentage as total of all percentages divided by number of months
    const averageCollectionPercent = validMonthsCount > 0 ? (totalCollectionPercent / validMonthsCount) : 0;

    const wsSummaryData = [
        ['Yearly Collection Summary'],
        ['Period', 'April 2025 - March 2026'],
        ['Generated Date', new Date().toLocaleDateString()],
        [''],
        ['Summary'],
        ['Metric', 'Amount'],
        ['Total Physical Archiving', totalPhysical],
        ['Total Digital Archiving', totalDigital],
        ['Grand Total Collection', grandTotal],
        ['Average Monthly Collection', averageMonthly],
        ['Number of Months', months.length],
        ['Average Collection %', averageCollectionPercent.toFixed(1) + '%']
    ];

    const wsSummary = XLSX.utils.aoa_to_sheet(wsSummaryData);
    XLSX.utils.book_append_sheet(wb, wsSummary, 'Summary');

    // Create monthly breakdown worksheet
    const monthlyData = [['Month', 'Physical Archiving', 'Digital Archiving', 'Total Collection', 'Collection %', 'Related Sales', 'Surplus/(Deficit)']];
    months.sort().forEach(month => {
        const data = yearSummaryData[month];
        const collectionPercent = data.netSales > 0 ? (data.total / data.netSales * 100) : 0;
        const surplusDeficit = data.total - data.netSales;
        
        monthlyData.push([
            month,
            data.physical,
            data.digital,
            data.total,
            collectionPercent.toFixed(1) + '%',
            data.netSales,
            surplusDeficit
        ]);
    });

    const wsMonthly = XLSX.utils.aoa_to_sheet(monthlyData);
    XLSX.utils.book_append_sheet(wb, wsMonthly, 'Monthly Breakdown');

    XLSX.writeFile(wb, 'Yearly_Collection_Summary.xlsx');
    
    // Show success toast
    showToast('Year Summary Excel file downloaded successfully', 'success');
}

// Download analysis PDF
function downloadAnalysisPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Add title
    doc.setFontSize(20);
    doc.text('Monthly Collection Analysis Report', 105, 20, { align: 'center' });

    // Add subtitle
    doc.setFontSize(12);
    doc.text('Collection Percentages and Surplus/Deficit Analysis', 105, 30, { align: 'center' });

    // Add generation date
    const today = new Date();
    doc.text(`Generated: ${today.toLocaleDateString()}`, 105, 37, { align: 'center' });

    // Define the correct order of months (fiscal year from April to March)
    const monthOrder = [
        'April 2025', 'May 2025', 'June 2025', 'July 2025', 
        'August 2025', 'September 2025', 'October 2025', 
        'November 2025', 'December 2025', 'January 2026', 
        'February 2026', 'March 2026'
    ];
    
    // Filter to only include months that have data
    const months = monthOrder.filter(month => allMonthsData[month]);
    let totalCollection = 0;
    let totalNetSales = 0;
    
    months.forEach(month => {
        const data = allMonthsData[month];
        totalCollection += data.total;
        totalNetSales += data.netSales;
    });

    const analysisData = [
        ['Month', 'Physical', 'Digital', 'Total', 'Collection %', 'Related Sales', 'Surplus/(Deficit)']
    ];

    months.forEach(month => {
        const data = allMonthsData[month];
        const collectionPercent = totalNetSales > 0 ? (data.total / data.netSales * 100) : 0;
        const surplusDeficit = data.total - data.netSales;
        
        analysisData.push([
            month,
            formatCurrency(data.physical),
            formatCurrency(data.digital),
            formatCurrency(data.total),
            collectionPercent.toFixed(1) + '%',
            formatCurrency(data.netSales),
            (surplusDeficit >= 0 ? '+' : '') + formatCurrency(surplusDeficit)
        ]);
    });

    doc.autoTable({
        head: [analysisData[0]],
        body: analysisData.slice(1),
        startY: 50,
        theme: 'grid',
        styles: {
            fontSize: 9,
            cellPadding: 2
        },
        headStyles: {
            fillColor: [102, 126, 234],
            textColor: 255
        }
    });

    doc.save('Monthly_Collection_Analysis.pdf');
    
    // Show success toast
    showToast('Analysis PDF downloaded successfully', 'success');
}

// Download analysis Excel
function downloadAnalysisExcel() {
    const wb = XLSX.utils.book_new();

    // Define the correct order of months (fiscal year from April to March)
    const monthOrder = [
        'April 2025', 'May 2025', 'June 2025', 'July 2025', 
        'August 2025', 'September 2025', 'October 2025', 
        'November 2025', 'December 2025', 'January 2026', 
        'February 2026', 'March 2026'
    ];
    
    // Filter to only include months that have data
    const months = monthOrder.filter(month => allMonthsData[month]);
    let totalCollection = 0;
    let totalNetSales = 0;
    
    months.forEach(month => {
        const data = allMonthsData[month];
        totalCollection += data.total;
        totalNetSales += data.netSales;
    });

    const analysisData = [
        ['Monthly Collection Analysis Report'],
        [''],
        ['Period', 'April 2025 - March 2026'],
        ['Generated Date', new Date().toLocaleDateString()],
        [''],
        ['Analysis Summary'],
        ['Total Collection', totalCollection],
        ['Total Related Sales', totalNetSales],
        ['Overall Collection Rate', ((totalCollection / totalNetSales) * 100).toFixed(1) + '%'],
        [''],
        ['Monthly Breakdown'],
        ['Month', 'Physical Archiving', 'Digital Archiving', 'Total Collection', 'Collection %', 'Related Sales', 'Surplus/(Deficit)']
    ];

    months.forEach(month => {
        const data = allMonthsData[month];
        const collectionPercent = totalNetSales > 0 ? (data.total / data.netSales * 100) : 0;
        const surplusDeficit = data.total - data.netSales;
        
        analysisData.push([
            month,
            data.physical,
            data.digital,
            data.total,
            collectionPercent.toFixed(1) + '%',
            data.netSales,
            surplusDeficit
        ]);
    });

    const wsAnalysis = XLSX.utils.aoa_to_sheet(analysisData);
    XLSX.utils.book_append_sheet(wb, wsAnalysis, 'Analysis');

    XLSX.writeFile(wb, 'Monthly_Collection_Analysis.xlsx');
    
    // Show success toast
    showToast('Analysis Excel file downloaded successfully', 'success');
}

// Toggle breakdown visibility
function toggleBreakdown() {
    const section = document.getElementById('breakdownSection');
    const btn = document.getElementById('breakdownBtn');

    if (isBreakdownVisible) {
        section.classList.remove('visible');
        btn.textContent = '📋 View Detailed Breakdown by Customer';
        isBreakdownVisible = false;
    } else {
        if (!breakdownProcessed) {
            processBreakdownData();
            breakdownProcessed = true;
        }
        section.classList.add('visible');
        btn.textContent = '📋 Hide Detailed Breakdown';
        isBreakdownVisible = true;
    }
}

// Show tab
function showTab(type) {
    const tabs = document.querySelectorAll('.tab-btn');
    const contents = document.querySelectorAll('.breakdown-content');

    tabs.forEach(tab => tab.classList.remove('active'));
    contents.forEach(content => content.classList.remove('active'));

    if (type === 'physical') {
        tabs[0].classList.add('active');
        document.getElementById('physicalContent').classList.add('active');
    } else {
        tabs[1].classList.add('active');
        document.getElementById('digitalContent').classList.add('active');
    }
}

// Process breakdown data
function processBreakdownData() {
    if (!breakdownData || breakdownData.length === 0) {
        document.getElementById('physicalContent').innerHTML = '<div class="no-data-message">No data available</div>';
        document.getElementById('digitalContent').innerHTML = '<div class="no-data-message">No data available</div>';
        return;
    }

    // Reset maps
    physicalMap = {};
    digitalMap = {};
    let processedCount = 0;

    // Debug: Log the first few rows to understand the structure
    console.log('Breakdown data - First 3 rows:', breakdownData.slice(0, 3));

    // Process ALL rows dynamically - no row limit
    for (let i = 1; i < breakdownData.length; i++) {
        const row = breakdownData[i];

        // Skip completely empty rows
        if (!row || row.length === 0) continue;

        // Skip rows without operating unit
        if (!row[0] || row[0].trim() === '') continue;

        const operatingUnit = row[0].trim();

        // Only process Physical or Digital Archiving rows
        if (operatingUnit !== 'Physical Archiving' && operatingUnit !== 'Digital Archiving') {
            continue;
        }

        // Get customer name from column J (index 9)
        const customerName = row[9] ? row[9].trim() : 'Unknown Customer';
        if (customerName === '') continue;

        // Get amount from column G (index 6)
        let amountStr = row[6];
        if (!amountStr || amountStr === '') continue;

        // Remove commas, spaces, and currency symbols
        amountStr = String(amountStr).replace(/,/g, '').replace(/\s/g, '').replace('Rs.', '').replace('LKR', '');
        const amount = parseFloat(amountStr);

        if (isNaN(amount) || amount === 0) continue;

        if (operatingUnit === 'Physical Archiving') {
            physicalMap[customerName] = (physicalMap[customerName] || 0) + amount;
            processedCount++;
        } else if (operatingUnit === 'Digital Archiving') {
            digitalMap[customerName] = (digitalMap[customerName] || 0) + amount;
            processedCount++;
        }
    }

    console.log('Breakdown - Total transactions processed:', processedCount);
    console.log('Physical customers:', Object.keys(physicalMap).length);
    console.log('Digital customers:', Object.keys(digitalMap).length);

    renderCategory('physicalContent', physicalMap, 'Physical Archiving');
    renderCategory('digitalContent', digitalMap, 'Digital Archiving');
}

// Render category breakdown
function renderCategory(containerId, dataMap, categoryName, searchTerm = '') {
    const container = document.getElementById(containerId);

    if (!dataMap || Object.keys(dataMap).length === 0) {
        container.innerHTML = '<div class="no-data-message">No data available for ' + categoryName + '</div>';
        return;
    }

    // Get filter type
    const type = containerId.includes('physical') ? 'physical' : 'digital';
    const filter = currentFilter[type];

    // Calculate thresholds for filtering
    const values = Object.values(dataMap);
    const max = Math.max(...values);
    const min = Math.min(...values);
    const range = max - min;
    
    const highThreshold = min + (range * 0.67);
    const mediumThreshold = min + (range * 0.33);

    // Filter data based on current filter and search term
    let filteredData = Object.entries(dataMap).filter(([customer, amount]) => {
        // Apply search filter
        if (searchTerm && !customer.toLowerCase().includes(searchTerm.toLowerCase())) {
            return false;
        }
        
        // Apply value filter
        if (filter === 'high' && amount < highThreshold) {
            return false;
        } else if (filter === 'medium' && (amount < mediumThreshold || amount >= highThreshold)) {
            return false;
        } else if (filter === 'low' && amount >= mediumThreshold) {
            return false;
        }
        
        return true;
    });

    // Sort by amount (descending)
    filteredData.sort((a, b) => b[1] - a[1]);

    let categoryTotal = 0;
    filteredData.forEach(([_, amount]) => categoryTotal += amount);

    let html = `
    <div class="summary-header">
    ${categoryName}: ${filteredData.length} Customers | Total: ${formatCurrency(categoryTotal)}
    </div>
    `;

    filteredData.forEach(([customer, amount]) => {
        html += `
    <div class="breakdown-item">
    <div class="customer-name">${customer}</div>
    <div class="amount">${formatCurrency(amount)}</div>
    </div>
    `;
    });

    container.innerHTML = html;
}

// Initialize on page load
window.addEventListener('load', function() {
    // Check for saved theme preference
    const savedTheme = localStorage.getItem('darkMode');
    if (savedTheme === 'true') {
        isDarkMode = true;
        document.body.classList.add('dark-mode');
        document.querySelector('.theme-toggle').textContent = '☀️';
    }
    
    // Initialize month selector
    initializeMonthSelector();
    
    // Update current date
    const today = new Date();
    const dateStr = today.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    document.getElementById('currentDate').textContent = dateStr;
});
</script>
</body>
</html>
